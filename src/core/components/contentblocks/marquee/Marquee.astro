---
// src/components/contentblocks/marquee/Marquee.astro
import {
  getProcessedConfig,
  getNamedInstanceConfig,
} from "@/core/bootstrap/store";
import type { MarqueeProps } from "./marquee.props";
import { defaultMarqueeProps } from "./marquee.props"; // 仅作极端兜底
import MarqueeRenderer from "./MarqueeRenderer.astro";

export interface Props extends Partial<MarqueeProps> {
  instanceId?: string;
}

const { instanceId, ...propsFromCaller } = Astro.props;

// 1. 获取全局默认 (已经是 User > Code Default)
const globalConfig =
  getProcessedConfig<MarqueeProps>("marquee") || defaultMarqueeProps;

// 2. 获取命名实例 (已经是 User Instance > Global > Code Default)
let instanceConfig: Partial<MarqueeProps> = {};
if (instanceId) {
  const found = getNamedInstanceConfig<MarqueeProps>("marquee", instanceId);
  if (found) {
    instanceConfig = found;
  } else {
    // Logger.warn(`Named instance '${instanceId}' not found for Marquee.`);
  }
}

// 3. 最终合并: 调用处 Props > 实例 > 全局
// 此时不需要深合并，因为 Props 通常是扁平覆盖，或者是使用者意图完全替换
const finalProps: MarqueeProps = {
  ...globalConfig,
  ...instanceConfig,
  ...propsFromCaller,
};

const shouldRender = finalProps.enable;
---

{shouldRender && <MarqueeRenderer {...finalProps} />}
